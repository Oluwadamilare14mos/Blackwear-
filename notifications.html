<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notifications â€” Blackwear</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        brand: "#ff7f00",
        dark: "#0b0b0b",
        notif: "#1f2937"
      },
      fontFamily: { poppins: ["Poppins", "sans-serif"] },
    },
  },
};
</script>
<style>
body { background: #0b0b0b; font-family: Poppins, sans-serif; }
</style>
</head>
<body class="min-h-screen text-white">

<header class="p-5 bg-dark shadow-lg flex justify-between items-center relative">
  <h1 class="text-2xl font-bold text-brand">Notifications</h1>
  <div class="relative">
    <button id="notifBtn" class="relative text-white text-xl">
      ðŸ””
      <span id="notifCount" class="absolute -top-2 -right-2 bg-red-500 text-xs w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
    </button>
    <div id="notificationsList" class="hidden absolute right-0 mt-2 bg-dark border border-gray-700 rounded-lg shadow-lg w-80 max-h-96 overflow-y-auto z-50"></div>
  </div>
</header>

<main class="p-5 max-w-4xl mx-auto">
  <p class="text-gray-400 text-center mt-5">Your notifications will appear here.</p>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBy0bIMp1ORV0UfLgKlxyr2V-I9mJjFb6o",
  authDomain: "blackwear-14a31.firebaseapp.com",
  projectId: "blackwear-14a31"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const notifBtn = document.getElementById("notifBtn");
const notifCount = document.getElementById("notifCount");
const notificationsList = document.getElementById("notificationsList");

// Toggle dropdown
notifBtn.addEventListener("click", () => {
  notificationsList.classList.toggle("hidden");
});

// Listen for auth state
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    await signInAnonymously(auth);
    return;
  }

  const q = query(
    collection(db, "notifications"),
    where("userId", "==", user.uid),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snap) => {
    notificationsList.innerHTML = "";
    let unread = 0;

    snap.forEach(docSnap => {
      const n = docSnap.data();
      const el = document.createElement("a");
      el.href = n.link || "#";
      el.className = "block p-3 border-b border-gray-700 hover:bg-gray-800 text-sm text-gray-300";
      if (!n.read) {
        unread++;
        el.classList.add("bg-notif");
      }

      el.textContent = n.message + " (" + (n.type || "") + ")";

      // Mark as read when clicked
      el.addEventListener("click", async (e) => {
        try {
          await updateDoc(doc(db, "notifications", docSnap.id), { read: true });
        } catch (err) {
          console.error("Failed to mark read:", err);
        }
      });

      notificationsList.appendChild(el);
    });

    notifCount.textContent = unread;
    notifCount.style.display = unread ? "flex" : "none";
  });
});
</script>

</body>
</html>
