<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Checkout | Blackwear</title>

<style>
body{margin:0;padding:20px;background:#0f0f0f;color:#fff;font-family:system-ui}
.card{max-width:900px;margin:auto;background:#141414;border-radius:14px;padding:18px}
h1,h2{margin:0 0 10px;color:#ff7f00}
input,textarea{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid #333;background:#000;color:#fff}
.btn{margin-top:14px;padding:14px;border:none;border-radius:14px;background:#ff7f00;color:#000;font-weight:bold;width:100%;cursor:pointer}
.order-item{display:flex;justify-content:space-between;font-size:14px;margin-top:6px}
.total{font-size:18px;font-weight:bold;margin-top:10px}
.bank{background:#000;padding:10px;border-radius:10px;color:#ff7f00;display:none;margin-top:10px}
</style>
</head>

<body>

<div class="card">
<h1>Checkout</h1>

<h2>Customer</h2>
<input id="name" placeholder="Full name">
<input id="phone" placeholder="Phone number">
<textarea id="address" placeholder="Delivery address"></textarea>

<h2>Order Summary</h2>
<div id="items"></div>
<div class="total" id="total">₦0</div>

<h2>Payment</h2>
<label><input type="radio" name="pay" value="paystack" checked> Paystack</label><br>
<label><input type="radio" name="pay" value="bank"> Bank Transfer</label>

<div class="bank" id="bankBox">
Bank: Olaniyi Funky / Opay<br>
Account: 8117854139<br>
Send proof to support after payment.
</div>

<button class="btn" id="payNow">Pay Now</button>
</div>

<!-- Paystack -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>

<!-- EmailJS (receipt ready) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
/* ================= CONFIG ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBy0bIMp1ORV0UfLgKlxyr2V-I9mJjFb6o",
  authDomain: "blackwear-14a31.firebaseapp.com",
  projectId: "blackwear-14a31"
});

emailjs.init("61XKawCOBMidGo2by"); // EmailJS public key

const PAYSTACK_KEY = "pk_live_f4916e7d98151010a57a6c3b5d12437af8a144af";

const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

const el = id => document.getElementById(id);

let CART = [];
let TOTAL = 0;
let paying = false;

/* ================= AUTH ================= */
auth.onAuthStateChanged(async user=>{
  if(!user) await auth.signInAnonymously();
  loadCart();
  requestNotificationPermission();
});

/* ================= LOAD CART ================= */
async function loadCart(){
  const snap = await db.collection("cart")
    .where("userId","==",auth.currentUser.uid)
    .get();

  CART = [];
  TOTAL = 0;
  el("items").innerHTML = "";

  snap.forEach(d=>{
    const p = d.data();
    CART.push({...p,id:d.id});
    TOTAL += Number(p.price) * Number(p.quantity || 1);

    el("items").innerHTML += `
      <div class="order-item">
        <span>${p.name}</span>
        <span>₦${Number(p.price).toLocaleString()}</span>
      </div>`;
  });

  el("total").textContent = "₦" + TOTAL.toLocaleString();
}

/* ================= PAYMENT SWITCH ================= */
document.querySelectorAll('input[name="pay"]').forEach(r=>{
  r.onchange = ()=> el("bankBox").style.display =
    r.value==="bank" ? "block" : "none";
});

/* ================= PAY NOW ================= */
el("payNow").onclick = ()=>{
  if(paying) return;

  const name = el("name").value.trim();
  const phone = el("phone").value.trim();
  const address = el("address").value.trim();
  const method = document.querySelector('input[name="pay"]:checked').value;

  if(!name || !phone || !address) return alert("Fill all details");
  if(!CART.length) return alert("Cart empty");

  paying = true;

  if(method==="paystack"){
    PaystackPop.setup({
      key: PAYSTACK_KEY,
      email: phone+"@blackwear.com",
      amount: TOTAL * 100,
      currency: "NGN",
      ref: "BW-" + Date.now(),
      callback: res => completeOrder("Paystack", res.reference, "paid_unverified"),
      onClose: ()=> paying=false
    }).openIframe();
  }else{
    alert("Transfer ₦"+TOTAL.toLocaleString()+" and send proof to support");
    completeOrder("Bank", "BANK-"+Date.now(), "awaiting_confirmation");
  }
};

/* ================= COMPLETE ORDER ================= */
async function completeOrder(method, reference, paymentStatus){
  const orderRef = await db.collection("orders").add({
    userId: auth.currentUser.uid,

    customer:{
      name: el("name").value,
      phone: el("phone").value,
      address: el("address").value
    },

    items: CART,
    total: TOTAL,

    payment:{
      method,
      reference,
      status: paymentStatus
    },

    orderStatus: "pending_admin_approval",
    deliveryStatus: "not_shipped",

    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  /* Clear cart */
  const batch = db.batch();
  CART.forEach(i=>batch.delete(db.collection("cart").doc(i.id)));
  await batch.commit();

  /* Send receipt email */
  emailjs.send("service_wu4fetn","template_pjd78fl",{
    to_name: el("name").value,
    order_id: orderRef.id,
    order_total: "₦"+TOTAL.toLocaleString(),
    payment_method: method,
    payment_ref: reference
  }).catch(()=>{});

  alert("Order placed successfully!");
  location.href = "track-order.html?id=" + orderRef.id;
}

/* ================= FCM NOTIFICATIONS ================= */
async function requestNotificationPermission() {
  try {
    await Notification.requestPermission();
    const token = await messaging.getToken({
      vapidKey: "BK8Y3DUVXJlxx1qGZYbV4MvlNcDtQCD54-KJcjxhf8QgK6aUO_XZblyIYOUtV_cLxsWxmLe9WZJH1dnGmu4CXwg"
    });
    console.log("FCM Token:", token);
    await db.collection("users").doc(auth.currentUser.uid).set(
      { fcmToken: token }, { merge: true }
    );
  } catch(err) {
    console.warn("Notification permission denied", err);
  }
}

  /* ================= NOTIFICATIONS ================= */

if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("/firebase-messaging-sw.js")
    .then(reg => {
      console.log("Service Worker registered");

      const messaging = firebase.messaging();

      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          messaging
            .getToken({
              vapidKey: "BK8Y3DUVXJlxx1qGZYbV4MvlNcDtQCD54-KJcjxhf8QgK6aUO_XZblyIYOUtV_cLxsWxmLe9WZJH1dnGmu4CXwg"
            })
            .then(token => {
              console.log("FCM Token:", token);

              if (firebase.auth().currentUser) {
                firebase
                  .firestore()
                  .collection("users")
                  .doc(firebase.auth().currentUser.uid)
                  .set({ fcmToken: token }, { merge: true });
              }
            });
        }
      });
    });
}
  
</script>
</body>
</html>
