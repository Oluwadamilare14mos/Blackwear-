<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Checkout | Blackwear</title>
<style>
body {
    margin: 0;
    padding: 20px;
    background: #0f0f0f;
    color: #fff;
    font-family: system-ui;
}
.card {
    max-width: 900px;
    margin: auto;
    background: #141414;
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
h1, h2 {
    margin: 0 0 10px;
    color: #ff7f00;
}
input, textarea {
    width: 100%;
    padding: 12px;
    margin-top: 8px;
    border-radius: 10px;
    border: 1px solid #333;
    background: #000;
    color: #fff;
}
.btn {
    margin-top: 20px;
    padding: 16px;
    border: none;
    border-radius: 14px;
    background: #ff7f00;
    color: #000;
    font-weight: bold;
    width: 100%;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s ease-in-out;
}
.btn:hover {
    background: #e56c00;
}
.order-item {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    margin-top: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid #222;
}
.total {
    font-size: 20px;
    font-weight: bold;
    margin-top: 12px;
    color: #ff7f00;
}
.bank {
    background: #000;
    padding: 14px;
    border-radius: 10px;
    color: #ff7f00;
    margin-top: 20px;
}
</style>
</head>
<body>

<div class="card">
<h1>Checkout</h1>

<h2>Customer Information</h2>
<input id="name" placeholder="Full name">
<input id="phone" placeholder="Phone number">
<textarea id="address" placeholder="Delivery address"></textarea>

<h2>Order Summary</h2>
<div id="items"></div>
<div class="total" id="total">â‚¦0</div>

<h2>Payment</h2>
<div class="bank">
<strong>Bank Transfer (Opay)</strong><br><br>
Account Name: Olaniyi Funke<br>
Bank: Opay<br>
Account Number: 8117854139<br><br>
After payment, click <b>Confirm Order</b>.<br>
Send proof to support if requested.
</div>

<button class="btn" id="confirmOrder">Confirm Order</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
// Firebase config
firebase.initializeApp({
  apiKey: "AIzaSyBy0bIMp1ORV0UfLgKlxyr2V-I9mJjFb6o",
  authDomain: "blackwear-14a31.firebaseapp.com",
  projectId: "blackwear-14a31"
});
emailjs.init("61XKawCOBMidGo2by");

const auth = firebase.auth();
const db = firebase.firestore();
const el = id => document.getElementById(id);

let CART = [];
let TOTAL = 0;
let submitting = false;

// Auth
auth.onAuthStateChanged(async user => {
    if(!user) await auth.signInAnonymously();
    loadCart();
});

// Load Cart
async function loadCart() {
    const snap = await db.collection("cart").where("userId","==",auth.currentUser.uid).get();
    CART = [];
    TOTAL = 0;
    el("items").innerHTML = "";

    if(snap.empty){
        el("items").innerHTML = "<p>Your cart is empty ðŸ›’</p>";
        el("total").textContent = "â‚¦0";
        return;
    }

    snap.forEach(d=>{
        const p = d.data();
        CART.push({...p,id:d.id});
        TOTAL += Number(p.price) * (p.quantity || 1);

        el("items").innerHTML += `
            <div class="order-item">
                <span>${p.productName || p.name}</span>
                <span>â‚¦${Number(p.price * (p.quantity || 1)).toLocaleString()}</span>
            </div>
        `;
    });
    el("total").textContent = "â‚¦" + TOTAL.toLocaleString();
}

// Confirm Order
el("confirmOrder").onclick = async () => {
    if(submitting) return;
    const name = el("name").value.trim();
    const phone = el("phone").value.trim();
    const address = el("address").value.trim();

    if(!name || !phone || !address) { alert("Fill all customer details"); return; }
    if(!CART.length) { alert("Your cart is empty"); return; }

    submitting = true;
    completeOrder();
}

// Complete Order
async function completeOrder() {
    const orderRef = await db.collection("orders").add({
        userId: auth.currentUser.uid,
        customer: { name: el("name").value, phone: el("phone").value, address: el("address").value },
        items: CART,
        total: TOTAL,
        payment: { method: "Opay Bank Transfer", reference: "OPAY-" + Date.now(), status: "awaiting_confirmation" },
        orderStatus: "pending_admin_approval",
        deliveryStatus: "not_shipped",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Clear Cart
    const batch = db.batch();
    CART.forEach(i => batch.delete(db.collection("cart").doc(i.id)));
    await batch.commit();

    // Send Receipt Email
    emailjs.send("service_wu4fetn","template_pjd78fl",{
        to_name: el("name").value,
        order_id: orderRef.id,
        order_total: "â‚¦" + TOTAL.toLocaleString(),
        payment_method: "Opay Bank Transfer",
        payment_ref: "OPAY"
    }).catch(()=>{});

    alert("Order placed successfully!");
    location.href = "track-order.html?id=" + orderRef.id + "&clearCart=1";
}
</script>

</body>
</html>
