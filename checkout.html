<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | Blackwear</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Arial}
body{background:#0f0f0f;color:#fff}
header{background:#000;padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #1f1f1f}
header h1{color:#ff7f00;font-size:20px}
.container{max-width:900px;margin:auto;padding:20px;display:grid;gap:20px}
.card{background:#141414;border:1px solid #1f1f1f;border-radius:16px;padding:16px}
.card h2{color:#ff7f00;font-size:18px;margin-bottom:12px}
input,textarea{width:100%;padding:12px;margin-bottom:10px;border-radius:12px;border:1px solid #2a2a2a;background:#000;color:#fff;outline:none}
.order-item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}
.total{font-size:20px;font-weight:bold;color:#ff7f00}
.btn{width:100%;padding:14px;border:none;border-radius:16px;background:#ff7f00;color:#000;font-weight:bold;font-size:16px;cursor:pointer;margin-top:10px}
.payment-option{margin-bottom:12px;padding:12px;border-radius:12px;background:#1a1a1a;border:1px solid #2a2a2a}
.mobile-bank-info{background:#000;color:#ff7f00;padding:10px;border-radius:12px;margin-top:8px;font-size:14px}
</style>
</head>
<body>

<header>
<button onclick="history.back()" style="background:none;border:none;color:#ff7f00;font-size:18px">←</button>
<h1>Checkout</h1>
</header>

<div class="container">

<div class="card">
<h2>Customer Details</h2>
<input id="name" placeholder="Full Name">
<input id="phone" placeholder="Phone Number">
<textarea id="address" placeholder="Delivery Address"></textarea>
</div>

<div class="card">
<h2>Order Summary</h2>
<div id="items"></div>
<hr style="border:1px solid #1f1f1f;margin:12px 0">
<p>Total: <span class="total" id="total">₦0</span></p>
</div>

<div class="card">
<h2>Payment Method</h2>

<div class="payment-option">
<label><input type="radio" name="payment" value="paystack" checked> Paystack</label>
</div>

<div class="payment-option">
<label><input type="radio" name="payment" value="mobilebank"> Mobile Bank</label>
<div class="mobile-bank-info" id="mobileBankInfo" style="display:none">
Bank: Olaniyi Funky / Opay<br>
Account: 8117854139<br>
Please transfer and send proof to support.
</div>
</div>
</div>

<button class="btn" id="payBtn">Pay Now</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBy0bIMp1ORV0UfLgKlxyr2V-I9mJjFb6o",
  authDomain: "blackwear-14a31.firebaseapp.com",
  projectId: "blackwear-14a31"
});

const auth = firebase.auth();
const db = firebase.firestore();

const nameEl = document.getElementById("name");
const phoneEl = document.getElementById("phone");
const addressEl = document.getElementById("address");
const items = document.getElementById("items");
const total = document.getElementById("total");
const mobileBankInfo = document.getElementById("mobileBankInfo");
const payBtn = document.getElementById("payBtn");

let cartItems = [];
let totalPrice = 0;
let paying = false;

auth.onAuthStateChanged(async user => {
  if (!user) await auth.signInAnonymously();
  loadCart();
});

async function loadCart(){
  const user = auth.currentUser;
  const snap = await db.collection("cart")
    .where("userId","==",user.uid)
    .get();

  cartItems = [];
  totalPrice = 0;
  items.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    cartItems.push({id: doc.id, ...d});
    totalPrice += Number(d.price);

    const row = document.createElement("div");
    row.className = "order-item";
    row.innerHTML = `<span>${d.name}</span><span>₦${Number(d.price).toLocaleString()}</span>`;
    items.appendChild(row);
  });

  total.textContent = "₦" + totalPrice.toLocaleString();
}

// Show mobile bank info
document.querySelectorAll('input[name="payment"]').forEach(radio=>{
  radio.addEventListener("change", ()=>{
    mobileBankInfo.style.display = radio.value==="mobilebank" ? "block" : "none";
  });
});

payBtn.onclick = async function(){
  if(paying) return;
  const n = nameEl.value.trim();
  const p = phoneEl.value.trim();
  const a = addressEl.value.trim();
  const method = document.querySelector('input[name="payment"]:checked').value;

  if(!n || !p || !a){ alert("Please fill all details"); return; }
  if(cartItems.length===0){ alert("Cart is empty"); return; }

  paying = true;

  const user = auth.currentUser;

  if(method==="paystack"){
    const handler = PaystackPop.setup({
      key: "pk_live_f4916e7d98151010a57a6c3b5d12437af8a144af",
      email: p+"@blackwear.com",
      amount: totalPrice*100,
      currency: "NGN",
      ref: "BW-"+Date.now(),
      callback: async function(response){
        await finalizeOrder(user, n, p, a, "Paystack", response.reference, "paid_unverified");
        alert("Payment successful! Ref: " + response.reference);
        window.location.href = "my-order.html";
      },
      onClose: function(){
        paying = false;
        alert("Payment cancelled.");
      }
    });
    handler.openIframe();
  } else {
    alert("Please transfer ₦"+totalPrice.toLocaleString()+" to the bank above and send proof to support.");
    await finalizeOrder(user, n, p, a, "Mobile Bank", "BANK-"+Date.now(), "awaiting_confirmation");
    window.location.href = "my-order.html";
  }
}

async function finalizeOrder(user, name, phone, address, method, reference, status){
  await db.collection("orders").add({
    userId: user.uid,
    customer: {name, phone, address},
    items: cartItems,
    total: totalPrice,
    payment: {method, reference, status},
    orderStatus: "pending_admin_approval",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  const batch = db.batch();
  cartItems.forEach(item => batch.delete(db.collection("cart").doc(item.id)));
  await batch.commit();
}
</script>
</body>
</html>
