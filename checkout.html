<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Checkout | Blackwear</title>
<style>
body{margin:0;padding:20px;background:#0f0f0f;color:#fff;font-family:system-ui}
.card{max-width:900px;margin:auto;background:#141414;border-radius:14px;padding:18px}
h1,h2{margin:0 0 10px;color:#ff7f00}
input,textarea{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid #333;background:#000;color:#fff}
.btn{margin-top:14px;padding:14px;border:none;border-radius:14px;background:#ff7f00;color:#000;font-weight:bold;width:100%;cursor:pointer}
.order-item{display:flex;justify-content:space-between;font-size:14px;margin-top:6px}
.total{font-size:18px;font-weight:bold;margin-top:10px}
.bank{background:#000;padding:10px;border-radius:10px;color:#ff7f00;margin-top:10px}
</style>
</head>
<body>

<div class="card">
  <h1>Checkout</h1>

  <h2>Customer</h2>
  <input id="name" placeholder="Full name">
  <input id="phone" placeholder="Phone number">
  <textarea id="address" placeholder="Delivery address"></textarea>

  <h2>Order Summary</h2>
  <div id="items"></div>
  <div class="total" id="total">₦0</div>

  <h2>Payment</h2>
  <div class="bank">
    <strong>Bank Transfer (Opay)</strong><br><br>
    Account Name: Olaniyi Funke<br>
    Bank: Opay<br>
    Account Number: 8117854139<br><br>
    After payment, click <b>Confirm Order</b>.<br>
    Send proof to support if requested.
  </div>

  <button class="btn" id="confirmOrder">Confirm Order</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBy0bIMp1ORV0UfLgKlxyr2V-I9mJjFb6o",
  authDomain: "blackwear-14a31.firebaseapp.com",
  projectId: "blackwear-14a31"
});

emailjs.init("61XKawCOBMidGo2by");

const auth = firebase.auth();
const db = firebase.firestore();
const el = id => document.getElementById(id);

let CART = [];
let TOTAL = 0;
let submitting = false;

/* ================= LOAD CART ================= */
async function loadCart(){
  const snap = await db.collection("cart").where("userId","==",auth.currentUser.uid).get();
  CART = [];
  TOTAL = 0;
  el("items").innerHTML = "";

  if(snap.empty){
    el("items").innerHTML = "<p>Your cart is empty</p>";
    el("total").textContent = "₦0";
    return;
  }

  snap.forEach(d=>{
    const p = d.data();
    CART.push({...p,id:d.id});
    TOTAL += Number(p.price) * (p.quantity || 1);

    el("items").innerHTML += `
      <div class="order-item">
        <span>${p.productName || p.name}</span>
        <span>₦${Number(p.price).toLocaleString()} x ${p.quantity || 1}</span>
      </div>
    `;
  });

  el("total").textContent = "₦" + TOTAL.toLocaleString();
}

/* ================= AUTH ================= */
auth.onAuthStateChanged(async user => {
  if(!user) await auth.signInAnonymously();
  loadCart();
});

/* ================= CONFIRM ORDER ================= */
el("confirmOrder").onclick = async () => {
  if(submitting) return;
  const name = el("name").value.trim();
  const phone = el("phone").value.trim();
  const address = el("address").value.trim();

  if(!name || !phone || !address){
    alert("Fill all customer details");
    return;
  }
  if(!CART.length){
    alert("Your cart is empty");
    return;
  }

  submitting = true;

  try {
    const orderId = "BW-" + Date.now();
    const orderData = {
      orderId: orderId,
      userId: auth.currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      customer: { name, phone, address },
      items: CART.map(i=>({
        productId: i.productId || "",
        productName: i.productName || i.name,
        image: i.image || "",
        price: i.price,
        quantity: i.quantity
      })),
      total: TOTAL,
      orderStatus: "pending",
      deliveryStatus: "pending",
      deliveryProcess: "Your order is being approved",
      estimatedDelivery: new Date(Date.now() + 3*24*60*60*1000).toDateString(), // +3 days
      deliveryUpdates: [{ text: "We deliver fast", time: firebase.firestore.FieldValue.serverTimestamp() }],
      payment: {
        method: "Opay",
        ref: orderId,
        status: "pending",
        verified: false,
        verifiedAt: null
      }
    };

    const orderRef = await db.collection("orders").add(orderData);

    // Clear cart
    const batch = db.batch();
    CART.forEach(i => batch.delete(db.collection("cart").doc(i.id)));
    await batch.commit();

    alert("Order placed successfully!");
    location.href = "track-order.html?id=" + orderRef.id + "&clearCart=1";

  } catch(err) {
    console.error(err);
    alert("Failed to place order. Try again.");
    submitting = false;
  }
};
</script>
</body>
</html>
