<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | Blackwear</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Arial}
body{background:#0f0f0f;color:#fff}
header{background:#000;padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #1f1f1f}
header h1{color:#ff7f00;font-size:20px}
.container{max-width:900px;margin:auto;padding:20px;display:grid;gap:20px}
.card{background:#141414;border:1px solid #1f1f1f;border-radius:16px;padding:16px}
.card h2{color:#ff7f00;font-size:18px;margin-bottom:12px}
input,textarea,select{width:100%;padding:12px;margin-bottom:10px;border-radius:12px;border:1px solid #2a2a2a;background:#000;color:#fff;outline:none}
.order-item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}
.total{font-size:20px;font-weight:bold;color:#ff7f00}
.btn{width:100%;padding:14px;border:none;border-radius:16px;background:#ff7f00;color:#000;font-weight:bold;font-size:16px;cursor:pointer;margin-top:10px}
.payment-option{margin-bottom:12px;padding:12px;border-radius:12px;background:#1a1a1a;cursor:pointer;border:1px solid #2a2a2a}
.payment-option:hover{border-color:#ff7f00}
.payment-option input{margin-right:10px}
.mobile-bank-info{background:#000;color:#ff7f00;padding:10px;border-radius:12px;margin-top:8px;font-size:14px}
</style>
</head>
<body>

<header>
<button onclick="history.back()" style="background:none;border:none;color:#ff7f00;font-size:18px">←</button>
<h1>Checkout</h1>
</header>

<div class="container">

<!-- CUSTOMER DETAILS -->
<div class="card">
<h2>Customer Details</h2>
<input type="text" id="name" placeholder="Full Name">
<input type="tel" id="phone" placeholder="Phone Number">
<textarea id="address" placeholder="Delivery Address"></textarea>
</div>

<!-- ORDER SUMMARY -->
<div class="card">
<h2>Order Summary</h2>
<div id="items"></div>
<hr style="border:1px solid #1f1f1f;margin:12px 0">
<p>Total: <span class="total" id="total">₦0</span></p>
</div>

<!-- PAYMENT OPTIONS -->
<div class="card">
<h2>Payment Method</h2>

<div class="payment-option">
<label><input type="radio" name="payment" value="paystack" checked> Paystack</label>
</div>

<div class="payment-option">
<label><input type="radio" name="payment" value="mobilebank"> Mobile Bank</label>
<div class="mobile-bank-info" id="mobileBankInfo" style="display:none">
Bank Name: Olaniyi Funky / Opay<br>
Account: 8117854139<br>
Please transfer and send proof to support.
</div>
</div>

</div>

<button class="btn" onclick="processPayment()">Pay Now</button>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- PAYSTACK -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBy0bIMp1ORV0UfLgKlxyr2V-I9mJjFb6o",
  authDomain: "blackwear-14a31.firebaseapp.com",
  projectId: "blackwear-14a31"
});

const auth = firebase.auth();
const db = firebase.firestore();

let cartItems = [];
let totalPrice = 0;

auth.onAuthStateChanged(async user => {
  if (!user) await auth.signInAnonymously();
  loadCart();
});

async function loadCart(){
  const user = auth.currentUser;
  const snap = await db.collection("cart")
    .where("userId","==",user.uid)
    .get();

  const list = document.getElementById("items");
  list.innerHTML = "";
  cartItems = [];
  totalPrice = 0;

  snap.forEach(doc=>{
    const d = doc.data();
    cartItems.push({id:doc.id, ...d});
    totalPrice += Number(d.price);

    const row = document.createElement("div");
    row.className = "order-item";
    row.innerHTML = `
      <span>${d.name}</span>
      <span>₦${Number(d.price).toLocaleString()}</span>
    `;
    list.appendChild(row);
  });

  document.getElementById("total").textContent =
    "₦" + totalPrice.toLocaleString();
}

// Show mobile bank info if selected
const radioButtons = document.querySelectorAll('input[name="payment"]');
radioButtons.forEach(r=>{
  r.addEventListener('change', ()=>{
    document.getElementById('mobileBankInfo').style.display = r.value==='mobilebank' ? 'block' : 'none';
  });
});

function processPayment(){
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();
  const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

  if(!name || !phone || !address){
    alert("Please fill all details");
    return;
  }

  const user = auth.currentUser;

  if(paymentMethod==='paystack'){
    let handler = PaystackPop.setup({
      key: 'pk_test_ad3148006e25bf014920d24e7c3589441d1a6f17',
      email: phone+'@example.com', // dummy email if user email unknown
      amount: totalPrice*100, // in kobo
      currency: "NGN",
      ref: ''+Math.floor(Math.random()*1000000000+1),
      callback: async function(response){
        await finalizeOrder(user, name, phone, address, 'Paystack');
        alert("Payment successful! Transaction ref: " + response.reference);
        window.location.href = "my-order.html";
      },
      onClose: function(){
        alert("Payment cancelled.");
      }
    });
    handler.openIframe();
  } else if(paymentMethod==='mobilebank'){
    alert("Please transfer ₦" + totalPrice.toLocaleString() + " to the bank below and send proof to support:\n\nBank: Olaniyi Funky / Opay\nAccount: 8117854139");
    finalizeOrder(user, name, phone, address, 'Mobile Bank');
  }
}

async function finalizeOrder(user, name, phone, address, method){
  await db.collection("orders").add({
    userId: user.uid,
    customer: { name, phone, address },
    items: cartItems,
    total: totalPrice,
    paymentMethod: method,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  const batch = db.batch();
  cartItems.forEach(i=>{
    batch.delete(db.collection("cart").doc(i.id));
  });
  await batch.commit();
}
</script>
</body>
</html>
